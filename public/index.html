<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Helalink — Launching Sept 13</title>
  <meta name="description" content="Helalink — Unlock real online earning methods. Launching Sept 13. Allow reminders for priority onboarding & launch bonuses.">
  <style>
    :root{
      --bg-1:#050515; --bg-2:#0a0f2a; --glass:rgba(255,255,255,0.06);
      --rainbow: linear-gradient(90deg,#ff0057,#ff7a00,#ffd400,#2be2a5,#00c6ff,#9b6bff,#ff0057);
      --gold-1:#ffd54a; --gold-2:#ffb300;
    }
    *{box-sizing:border-box;font-family:Inter, Poppins, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#f5faff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* HERO */
    .hero{position:relative;display:grid;grid-template-columns:1.2fr 480px;gap:48px;align-items:center;padding:64px;min-height:100vh}
    #bgCanvas{position:absolute;inset:0;z-index:0}
    .hero-content{position:relative;z-index:2}

    .eyebrow{color:rgba(255,255,255,0.7);font-weight:700;letter-spacing:.12em;margin-bottom:10px;text-transform:uppercase}
    .big-header{font-size:44px;line-height:1.05;margin:0 0 10px;background:var(--rainbow);-webkit-background-clip:text;background-clip:text;color:transparent}
    .typing{display:inline-block;font-weight:800;font-size:22px;color:transparent;background:var(--rainbow);-webkit-background-clip:text;background-clip:text}
    .lead{margin-top:12px;color:rgba(231,241,255,0.85);font-size:18px;max-width:720px}

    .meta{display:flex;gap:20px;align-items:center;margin-top:24px;flex-wrap:wrap}

    /* Glowing countdown */
    .countdown{display:flex;gap:12px}
    .cd-box{position:relative;min-width:92px;padding:12px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.03));text-align:center}
    .cd-num{font-size:28px;font-weight:900;letter-spacing:1px;filter: drop-shadow(0 0 10px rgba(255,255,255,0.25));
      background:var(--rainbow);-webkit-background-clip:text;background-clip:text;color:transparent;animation:neon 2.2s ease-in-out infinite}
    .cd-lbl{font-size:12px;color:rgba(255,255,255,0.7)}
    @keyframes neon{0%,100%{text-shadow:0 0 10px rgba(255,255,255,0.25)}50%{text-shadow:0 0 24px rgba(255,255,255,0.55)}}

    /* CTA */
    .cta-wrap{display:flex;gap:14px}
    .btn{padding:14px 22px;border-radius:999px;border:0;cursor:pointer;font-weight:800}
    .btn-join{position:relative;background:#0b122e;color:#f5faff;border:2px solid transparent;border-image:var(--rainbow) 1;}
    .btn-join::after{content:"";position:absolute;inset:-2px;border-radius:999px;background:var(--rainbow);filter:blur(10px);opacity:.35;z-index:-1}
    .btn-join:hover{transform:translateY(-1px)}
    .pulse{animation:pulse-glow 1.4s ease-in-out infinite}
    @keyframes pulse-glow{0%{box-shadow:0 0 0 0 rgba(255,255,255,0.12)}70%{box-shadow:0 0 0 12px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}

    /* Right panel: Rainbow circle with orbiting shine */
    .panel{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:22px}
    .logo-wrap{width:360px;height:360px;display:flex;align-items:center;justify-content:center;position:relative}
    .logo-svg{width:300px;height:300px}
    .logo-center{position:absolute;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;z-index:3}
    .logo-title{font-weight:900;font-size:30px;letter-spacing:6px}
    .logo-sub{font-size:12px;color:rgba(255,255,255,0.65);margin-top:6px}
    .orbit{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .shine{width:24px;height:24px;border-radius:50%;background:radial-gradient(circle, rgba(255,255,255,0.95), rgba(255,255,255,0.1));filter:blur(6px);box-shadow:0 0 24px rgba(255,255,255,0.55);transform-origin: -140px 0px;}
    .orbit.rotate{animation:spin 5.5s linear infinite}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

    /* coin/note stage - inside circle area */
    .coin-stage{position:absolute;width:220px;height:220px;border-radius:50%;overflow:hidden;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:2}
    .money{position:absolute;top:-40px;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;color:#4a2d00;font-size:14px;background:radial-gradient(circle at 30% 30%, var(--gold-1), var(--gold-2));box-shadow:0 6px 12px rgba(0,0,0,0.35);opacity:0.98}
    .money.note{width:46px;height:30px;border-radius:6px;background:linear-gradient(160deg,#e8f6d7,#d4f3a6);color:#063;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px}
    .money .label{position:relative;z-index:2}
    .money::after{content:'';position:absolute;inset:0;border-radius:inherit;box-shadow:inset 0 1px 0 rgba(255,255,255,0.5);pointer-events:none}
    @keyframes fall {0%{transform:translateY(-40px) translateX(0) rotate(0deg);opacity:1}80%{opacity:1}100%{transform:translateY(260px) translateX(var(--dx,0px)) rotate(720deg);opacity:0}}

    footer{padding:28px;text-align:center;color:rgba(255,255,255,0.45);font-size:13px}

    @media(max-width:980px){.hero{grid-template-columns:1fr;gap:28px;padding:28px}.panel{order:-1}.logo-wrap{width:300px;height:300px}.logo-svg{width:260px;height:260px}.coin-stage{width:180px;height:180px}}

    /* Notify Section */
    .notify{text-align:center;padding:28px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:16px;margin:30px auto;max-width:720px;display:flex;align-items:center;gap:18px;justify-content:center}
    .notify-box{display:flex;align-items:center;gap:14px}
    .notify .emoji{font-size:34px;animation:bounce 1.2s infinite}
    .notify-caption{font-size:16px;color:#fff;text-shadow:0 0 8px rgba(255,255,255,0.12);text-align:left}
    .notify-cta{display:flex;flex-direction:column;align-items:flex-start;gap:8px}
    .notify-small{font-size:13px;color:rgba(255,255,255,0.65)}
    .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:linear-gradient(90deg,#2be2a5,#00c6ff);color:#041229;font-weight:800}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

    /* Earning Section */
    .earning{Padding:60px 20px;text-align:center}
    .earn-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:20px}
    .earn-card{padding:24px;border-radius:18px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));font-size:18px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,0.35);transition:transform .28s,box-shadow .28s}
    .earn-card span{display:block;font-size:14px;font-weight:400;color:rgba(255,255,255,0.8);margin-top:10px}
    .earn-card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,0.45)}

    /* Bots */
    .bots{padding:60px 20px;max-width:880px;margin:auto}
    .bot{margin:14px 0;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005))}
    .bot-q{width:100%;text-align:left;padding:16px;background:transparent;color:#fff;font-weight:800;cursor:pointer;border:none;font-size:16px}
    .bot-q:hover{background:rgba(255,255,255,0.02)}
    .bot-a{padding:16px;display:none;background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.9);font-weight:600}
    .bot-actions{margin-top:12px;display:flex;gap:10px}
    .btn-ghost{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;font-weight:700;cursor:pointer}

    /* small toast */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,#0b122e,rgba(11,18,46,0.6));padding:12px 16px;border-radius:12px;color:#fff;box-shadow:0 12px 30px rgba(6,7,12,0.6);display:none}

.hero-showcase {
  margin: 28px auto;
  width: 100%;
  max-width: 900px;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 10px 28px rgba(0,0,0,0.55);
}
.hero-showcase img {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
}
.hero-caption {
  font-size: 14px;
  color: rgba(255,255,255,0.65);
  margin-top: 8px;
  text-align: center;
}

  </style>
</head>
<body>
  <div class="page">
    <section class="hero">
      <canvas id="bgCanvas" aria-hidden="true"></canvas>

      <div class="hero-content">
        <div class="eyebrow">Helalink • Online Business Platform</div>
        <h2 class="big-header">The future of online earning starts here</h2>
        <h1><span class="typing" id="typingText" aria-hidden="true"></span></h1>
        <p class="lead">Be among the first to access simple, real ways to earn online with Helalink. Early members get priority onboarding, insider tips, and launch bonuses. Join now before spots fill up.</p>

<!-- Full-width Showcase -->
<div class="hero-showcase">
  <img src="https://i.postimg.cc/3wwPPSWV/IMG-20250814-WA0004.jpg" 
       alt="T-shirt with INTERNET / MONEY MAKERS print" loading="lazy" decoding="async">
  <p class="hero-caption">Branding sample — INTERNET MONEY MAKERS</p>
</div>

        <div class="meta">
          <div class="countdown" aria-live="polite">
            <div class="cd-box"><div id="d" class="cd-num">--</div><div class="cd-lbl">Days</div></div>
            <div class="cd-box"><div id="h" class="cd-num">--</div><div class="cd-lbl">Hours</div></div>
            <div class="cd-box"><div id="m" class="cd-num">--</div><div class="cd-lbl">Minutes</div></div>
            <div class="cd-box"><div id="s" class="cd-num">--</div><div class="cd-lbl">Seconds</div></div>
          </div>
          <div class="cta-wrap">
            <button id="joinBtn" type="button" class="btn btn-join pulse" aria-label="Join via WhatsApp">Join Early on WhatsApp</button>
            <button id="testPush" type="button" class="btn btn-join" style="background:#081230">Send Test Push</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="logo-wrap" aria-hidden="true">
          <svg class="logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="rainbow" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#ff0057" />
                <stop offset="16%" stop-color="#ff7a00" />
                <stop offset="33%" stop-color="#ffd400" />
                <stop offset="50%" stop-color="#2be2a5" />
                <stop offset="66%" stop-color="#00c6ff" />
                <stop offset="83%" stop-color="#9b6bff" />
                <stop offset="100%" stop-color="#ff0057" />
              </linearGradient>
            </defs>
            <g transform="translate(100,100)">
              <circle r="78" fill="rgba(255,255,255,0.02)" stroke="url(#rainbow)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" />
            </g>
          </svg>

          <!-- coin-stage sits above the SVG circle and clips coins/notes inside a circular mask -->
          <div class="coin-stage" aria-hidden="true"></div>

          <div class="logo-center">
            <div class="logo-title">HELALINK</div>
          <div class="logo-sub">Launching Sept 13</div>
          </div>
          <div class="orbit rotate"><div class="shine" aria-hidden="true"></div></div>
        </div>
      </div>
    </section>
<!-- Recent Members Section with HELALINK banner -->
<section class="joined-section" aria-labelledby="joinedTitle">
  <div class="live-header">
    <h2 id="joinedTitle">🎉 Recent Members Joined</h2>
    <div class="live-status" aria-live="polite">
      <span class="dot" aria-hidden="true"></span>
      <span class="sr-only">Live feed active</span>
      <span> Live feed active now</span>
    </div>
  </div>

  <!-- Total Counter -->
  <div class="total-counter" role="status">
    🔢 Total Members: <span id="totalCount">0</span>
  </div>

  <!-- Hot Country -->
  <div class="hot-country">
    🌍🔥 Hottest Country Today: <span id="hotCountry">Loading...</span>
  </div>

  <!-- Highlighted member (fades & slides in) -->
  <div class="joined-fade" id="joinedFade" aria-hidden="false">
    <div class="member-card show" id="member1" role="article" aria-label="Highlighted member"></div>
    <div class="member-card" id="member2" role="article" aria-label="Next member"></div>
    <!-- confetti container -->
    <div id="confettiContainer" aria-hidden="true"></div>
  </div>

  <!-- Join Streaks -->
  <div class="join-streaks" id="joinStreakContainer">
    📈 <span id="joinStreak">No streak yet...</span>
  </div>

  <!-- Leaderboard style (Top 5 recent members list) -->
  <div class="leaderboard" aria-label="Top 5 recent joins">
    <h3>👥 Top 5 Recent Joins</h3>
    <ul id="leaderboardList" aria-live="polite"></ul>
  </div>
</section>

<style>
/* Joined-section specific styles were kept inline earlier; nothing to change here */
</style>

    <!-- Notification Section: Browser + Signal subscribe -->
    <section class="notify" role="region" aria-label="Launch reminders">
      <div class="notify-box">
        <span class="emoji" aria-hidden="true">👉</span>
      </div>
      <div class="notify-cta">
        <div class="notify-caption"><strong>Get daily launch reminders + bonus alerts — choose Signal or browser.</strong></div>
        <div class="notify-small">We’ll nudge you every day until launch and remind you about activation so you don’t miss priority bonuses.</div>
      </div>
      <div style="margin-left:18px;display:flex;flex-direction:column;align-items:flex-end;gap:10px;">
        <button id="notifyBtn" type="button" class="btn btn-join pulse" aria-label="Allow browser reminders">Browser Reminders</button>
        <button id="signalBtn" type="button" class="btn btn-join" aria-label="Subscribe via Signal">Remind me on Signal</button>
        <div id="subBadge" class="badge" style="display:none">Subscribed</div>
      </div>
    </section>

    <!-- Ways of Earning Section -->
    <section class="earning">
      <h2 class="big-header">Ways of Earning</h2>
      <div class="earn-grid">
        <div class="earn-card">▶️ Watching YouTube Videos<br><span>Est: KSh 2k/day · KSh 14k/week</span></div>
        <div class="earn-card">▶️ Watching TikTok Videos<br><span>Est: KSh 2k/day · KSh 14k/week</span></div>
        <div class="earn-card">▶️ Watching Instagram Videos<br><span>Est: KSh 1.5k/day · KSh 10.5k/week</span></div>
        <div class="earn-card">▶️ Clicking Netflix Ads<br><span>Est: KSh 3k/day · KSh 21k/week</span></div>
        <div class="earn-card">🎮 Aviator (Mini-games)<br><span>Est: KSh 5k/day · KSh 35k/week (higher risk)</span></div>
        <div class="earn-card">😂 Creating Memes<br><span>Est: KSh 2k/day · KSh 14k/week</span></div>
        <div class="earn-card">✍️ Academic Writing<br><span>Est: KSh 7k/day · KSh 49k/week</span></div>
        <div class="earn-card">🤝 Affiliate Marketing<br><span>Est: KSh 5k/day · KSh 35k/week</span></div>
        <div class="earn-card">📋 Surveys<br><span>Est: KSh 1k/day · KSh 7k/week</span></div>
        <div class="earn-card">🎁 Welcome Bonus<br><span>One-time credit: KSh 1k–5k (bonus on signup)</span></div>
      </div>
      <p style="text-align:center;color:rgba(255,255,255,0.7);margin-top:18px;font-size:14px">Earnings shown are estimates and depend on effort, location, and market conditions. Results may vary.</p>
    </section>

    <!-- Bots Section -->
    <section class="bots">
      <h2 class="big-header">🤖 Smart Bots to Guide You</h2>

      <div class="bot">
        <button class="bot-q" type="button">💪 Motivation Bot: Why start an online business?</button>
        <div class="bot-a">Financial freedom starts with small consistent steps. Helalink pairs training + small tasks so you earn while learning.<div class="bot-actions"><button class="btn-ghost" data-wa-message="I'm%20interested%20in%20joining%20-%20tell%20me%20about%20bonuses" type="button">Join via WhatsApp</button><button class="btn-ghost" data-action="more" type="button">Tell me more</button></div></div>
      </div>

      <div class="bot">
        <button class="bot-q" type="button">📚 Training Bot: How will I learn?</button>
        <div class="bot-a">We provide step-by-step lessons, short videos, and practice tasks. Newcomers get priority coaching during launch.<div class="bot-actions"><button class="btn-ghost" data-wa-message="How%20do%20I%20start%20the%20training%20for%20Helalink%3F" type="button">Start Training (WhatsApp)</button><button class="btn-ghost" data-action="curriculum" type="button">See curriculum</button></div></div>
      </div>

      <div class="bot">
        <button class="bot-q" type="button">🛠 Onboarding Bot: Why pay activation fee?</button>
        <div class="bot-a">Activation fees cover onboarding, verification & bonus pools. Think of it as capital to kickstart your micro-business. <div class="bot-actions"><button class="btn-ghost" data-wa-message="I%20want%20to%20pay%20the%20activation%20fee%20-%20how%20do%20I%20proceed%3F" type="button">Pay/Ask on WhatsApp</button></div></div>
      </div>

      <div class="bot">
        <button class="bot-q" type="button">🤝 Support Bot: Do I need an account?</button>
        <div class="bot-a">Yes — accounts secure your earnings, track affiliate activity and enable payouts. Creating an account is quick and free (fee applies to activation).<div class="bot-actions"><button class="btn-ghost" data-wa-message="I%20want%20to%20create%20an%20account%20-%20what%20do%20I%20need%3F" type="button">Create account (WhatsApp)</button></div></div>
      </div>
    </section>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <footer>© 2025 Helalink • Launching September 13 • Early access via WhatsApp & Signal</footer>
  </div>

  <script>
/* ------------------ Small util helpers (kept self-contained) ------------------ */
function openUrlSafe(url){
  const a = document.createElement('a');
  a.href = url; a.target = '_blank'; a.rel = 'noopener noreferrer';
  document.body.appendChild(a); a.click(); a.remove();
}
function openWhatsApp(message){
  const phone = '254717028877';
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
  openUrlSafe(url);
}
function openSignal(){
  const phone = '+254717028877';
  const url = `https://signal.me/#p/${phone}`;
  openUrlSafe(url);
}
function showToast(msg, ms = 4200){
  const t = document.getElementById('toast');
  if(!t) return;
  t.textContent = msg; t.style.display = 'block';
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(()=>{ t.style.display = 'none'; }, ms);
}
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map((c) => c.charCodeAt(0)));
}

/* ------------------ Countdown UI (timezone-safe) ------------------ */
(function countdownInit(){
  const d=document.getElementById('d'), h=document.getElementById('h'), m=document.getElementById('m'), s=document.getElementById('s');
  // Explicit timezone for Nairobi (UTC+3) to avoid parsing differences across browsers
  const launchIso = '2025-09-13T00:00:00+03:00';
  const launch = new Date(launchIso);

  function pad(n){ return String(n).padStart(2,'0'); }

  function tick(){
    const now = new Date();
    let diff = launch.getTime() - now.getTime();
    if(diff <= 0){
      d.textContent=h.textContent=m.textContent=s.textContent='00';
      return;
    }
    const days = Math.floor(diff / (1000*60*60*24));
    diff %= (1000*60*60*24);
    const hours = Math.floor(diff / (1000*60*60));
    diff %= (1000*60*60);
    const mins = Math.floor(diff / (1000*60));
    diff %= (1000*60);
    const secs = Math.floor(diff / 1000);

    d.textContent = pad(days);
    h.textContent = pad(hours);
    m.textContent = pad(mins);
    s.textContent = pad(secs);
  }
  tick(); setInterval(tick,1000);
})();

/* ------------------ Service Worker + Push Subscription (robust) ------------------ */
let swReg = null;
let isSubscribed = false;

async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) {
    console.warn('No Service Worker support');
    return;
  }
  // Attempt sensible file names in order; your server can map /sw.js -> /service-worker.js if you prefer
  const candidates = ['/service-worker.js', '/sw.js'];
  for(const path of candidates){
    try{
      swReg = await navigator.serviceWorker.register(path);
      console.log('Service Worker registered at', path, swReg);
      const sub = await swReg.pushManager.getSubscription();
      isSubscribed = !!sub;
      updateSubBadge(isSubscribed);
      return swReg;
    } catch(err){
      console.warn('SW register failed for', path, err);
      // try next candidate
    }
  }
  console.error('Service Worker registration failed for all candidates.');
}

function updateSubBadge(flag){
  const b = document.getElementById('subBadge');
  if(!b) return;
  b.style.display = flag ? 'inline-block' : 'none';
}

/** Fetch VAPID public key - supports raw text or JSON { publicKey } */
async function fetchVapidPublicKey(){
  const resp = await fetch('/api/vapidPublicKey');
  if(!resp.ok) throw new Error('Failed to fetch VAPID key');
  const ct = (resp.headers.get('content-type') || '');
  if(ct.includes('application/json')){
    const j = await resp.json();
    return (j.publicKey || j.vapidPublicKey || j.key || '').trim();
  } else {
    return (await resp.text()).trim();
  }
}

async function subscribeForHelalink() {
  if (!('serviceWorker' in navigator)) throw new Error('ServiceWorker not supported');
  if (!('PushManager' in window)) throw new Error('Push not supported');

  // ensure SW registered
  if(!swReg) await registerServiceWorker();
  if(!swReg) throw new Error('Service Worker not available');

  // Permission; bail out early if denied
  if(Notification.permission === 'denied') throw new Error('Notification permission was previously denied');
  if(Notification.permission !== 'granted'){
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') throw new Error('Notification permission denied');
  }

  // Get VAPID public key
  const vapidPublicKey = await fetchVapidPublicKey();
  if(!vapidPublicKey) throw new Error('VAPID public key missing from server');

  const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);

  // subscribe
  const subscription = await swReg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey
  });

  // Send serializable payload to server (use subscription.toJSON())
  const launchIso = '2025-09-13T00:00:00+03:00';
  const dailyTimes = ['09:00','13:00','19:00'];
  const payload = {
    subscription: subscription.toJSON ? subscription.toJSON() : subscription,
    launchIso,
    dailyTimes,
    timezone: 'Africa/Nairobi',
    meta: { source: 'site' }
  };

  const r = await fetch('/api/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> 'server error');
    // if server responded with 409 (already exists) you might still want to mark subscribed
    throw new Error('Server subscribe failed: ' + txt);
  }
  const json = await r.json().catch(()=> ({}));
  console.log('Subscribed on server', json);
  localStorage.setItem('helalink_sub_id', json.id || '');
  isSubscribed = true;
  updateSubBadge(true);
  return json;
}

async function unsubscribeForHelalink() {
  if (!swReg) {
    await registerServiceWorker();
    if (!swReg) return;
  }
  const existing = await swReg.pushManager.getSubscription();
  if (!existing) {
    isSubscribed = false; updateSubBadge(false); showToast('No existing subscription.');
    return;
  }
  try {
    await existing.unsubscribe();
  } catch(e){
    console.warn('Error during unsubscribe:', e);
  }
  // inform server (best-effort)
  try {
    await fetch('/api/unsubscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ endpoint: existing.endpoint, id: localStorage.getItem('helalink_sub_id') || undefined })
    });
  } catch(e){
    console.warn('Server unsubscribe failed', e);
  }
  isSubscribed = false;
  updateSubBadge(false);
  showToast('Unsubscribed from browser reminders.');
}

/* ------------------ DOM hooks ------------------ */
document.addEventListener('DOMContentLoaded', async () => {
  // register SW early (no await so UI loads fast; registerServiceWorker does retries)
  registerServiceWorker().catch(()=>{});

  // typing animation
  const typingEl = document.getElementById('typingText');
  const fullText = 'HELALINK — coming soon';
  let idx = 0; const speed = 85;
  (function type(){
    if(idx <= fullText.length){
      typingEl.textContent = fullText.slice(0, idx++);
      setTimeout(type, speed);
    }
  })();

  // Join btn: subscribe then open WA (best-effort)
  document.getElementById('joinBtn').addEventListener('click', async () => {
    try {
      await subscribeForHelalink();
      showToast('Subscribed. Opening WhatsApp...');
    } catch (err) {
      console.warn('subscribe failed', err);
      showToast('Could not subscribe: ' + (err.message || err));
    } finally {
      openWhatsApp('Hi! I want to join Helalink early. Please send onboarding steps.');
    }
  });

  // Browser notify button
  document.getElementById('notifyBtn').addEventListener('click', async () => {
    try {
      await subscribeForHelalink();
      showToast('Subscribed to browser reminders.');
    } catch (err) {
      console.error(err);
      showToast('Could not subscribe: ' + (err.message || err));
    }
  });

  // Signal button
  document.getElementById('signalBtn').addEventListener('click', ()=>{
    openSignal();
    localStorage.setItem('helalink_signal_sub', 'requested');
    document.getElementById('subBadge').style.display = 'inline-block';
    showToast("Opened Signal — send the message to subscribe.");
  });

  // test push (server-level test to all subs)
  document.getElementById('testPush').addEventListener('click', async () => {
    try {
      const r = await fetch('/api/test-notification', { method: 'POST' });
      if(r.ok){
        const j = await r.json().catch(()=>({}));
        if(j.success) showToast('Test notification triggered.');
        else showToast('Test triggered, server responded.');
      } else {
        const txt = await r.text().catch(()=> 'server error');
        showToast('Test failed: ' + txt);
      }
    } catch (e) {
      console.error(e);
      showToast('Failed to trigger test.');
    }
  });

  // long-press / contextmenu on badge to unsubscribe (hidden quick action)
  const subBadge = document.getElementById('subBadge');
  if(subBadge){
    subBadge.addEventListener('contextmenu', (e) => { e.preventDefault(); unsubscribeForHelalink(); });
    // also allow a double-click to unsubscribe (convenience on mobile)
    subBadge.addEventListener('dblclick', (e) => { unsubscribeForHelalink(); });
  }

  // Bot accordion
  document.querySelectorAll('.bot-q').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ans = btn.nextElementSibling;
      const open = ans.style.display === 'block';
      document.querySelectorAll('.bot-a').forEach(a=>a.style.display='none');
      ans.style.display = open ? 'none' : 'block';
      if(!open) showToast('Tip: Use the WhatsApp buttons inside answers to join quickly');
    });
  });

  // bot action buttons (delegate)
  document.querySelectorAll('.bot-actions').forEach(group=>{
    group.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.matches('[data-wa-message]')){
        openWhatsApp(decodeURIComponent(t.getAttribute('data-wa-message')));
      } else if(t.matches('[data-action]')){
        const a = t.getAttribute('data-action');
        if(a === 'more') showToast('We match weekly goals with rewards — check updates in WhatsApp.');
        if(a === 'curriculum') showToast('Curriculum: Basics → Tasks → Scaling → Referral growth.');
      }
    });
  });

  // update UI from existing subscription if present
  try {
    if(navigator.serviceWorker){
      const r = await navigator.serviceWorker.getRegistration();
      const sub = r ? await r.pushManager.getSubscription() : null;
      if(sub) {
        isSubscribed = true; updateSubBadge(true);
      }
    }
  } catch(e){ console.warn('Error checking subscription state', e); }
});
</script>
</body>
</html>
